services:
  postgres:
    image: postgres:16-alpine
    container_name: uni-status-postgres-test
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-uni_status}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-uni_status_dev}
      POSTGRES_DB: ${POSTGRES_DB:-uni_status}
    volumes:
      - postgres_data_test:/var/lib/postgresql/data
      - ./fixtures/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-uni_status}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - uni-status-test

  redis:
    image: redis:7-alpine
    container_name: uni-status-redis-test
    command: redis-server --appendonly yes
    volumes:
      - redis_data_test:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - uni-status-test

  db-migrate:
    build:
      context: ..
      dockerfile: docker/db-migrate/Dockerfile
    container_name: uni-status-db-migrate-test
    command: ["sh", "-c", "yes | pnpm exec drizzle-kit push --force || true && touch /tmp/migration-complete && tail -f /dev/null"]
    environment:
      - UNI_STATUS_DB_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - DATABASE_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/migration-complete"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - uni-status-test
    restart: unless-stopped

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
      target: production
    container_name: uni-status-api-test
    environment:
      - DEPLOYMENT_TYPE=HOSTED
      - NODE_ENV=test
      - UNI_STATUS_URL=http://haproxy
      - UNI_STATUS_DB_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - UNI_STATUS_REDIS_URL=redis://redis:6379
      - UNI_STATUS_API_PORT=3001
      - RUN_REPORTS_INLINE=1
      - UNI_STATUS_AUTH_SECRET=${UNI_STATUS_AUTH_SECRET:-super-secret-key-change-in-production-32}
      - UNI_STATUS_CORS_ENABLED=true
      - UNI_STATUS_DISABLE_RATE_LIMITS=true
      # Keygen.sh licensing (for webhook verification in tests)
      - UNI_STATUS_KEYGEN_WEBHOOK_SECRET=${UNI_STATUS_KEYGEN_WEBHOOK_SECRET:-test-webhook-secret}
    expose:
      - "3001"
    depends_on:
      db-migrate:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ../apps/api/src:/app/apps/api/src
      - ../packages:/app/packages
      - /app/node_modules
      - reports_data_test:/app/reports
      - uploads_data_test:/app/apps/api/uploads
    networks:
      - uni-status-test

  web:
    build:
      context: ..
      dockerfile: apps/web/Dockerfile
      target: production
      args:
        - DATABASE_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
        - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-super-secret-key-change-in-production}
        - UNI_STATUS_URL=http://haproxy
    container_name: uni-status-web-test
    environment:
      - DEPLOYMENT_TYPE=HOSTED
      - NODE_ENV=test
      - UNI_STATUS_URL=http://haproxy
      - INTERNAL_API_URL=http://api:3001
      - UNI_STATUS_DB_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - UNI_STATUS_AUTH_SECRET=${UNI_STATUS_AUTH_SECRET:-super-secret-key-change-in-production-32}
    expose:
      - "3000"
    depends_on:
      - api
    networks:
      - uni-status-test

  workers:
    build:
      context: ..
      dockerfile: apps/workers/Dockerfile
      target: production
    container_name: uni-status-workers-test
    environment:
      - DEPLOYMENT_TYPE=HOSTED
      - NODE_ENV=test
      - UNI_STATUS_URL=http://haproxy
      - UNI_STATUS_DB_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - UNI_STATUS_REDIS_URL=redis://redis:6379
      - UNI_STATUS_SMTP_HOST=${SMTP_HOST:-mailhog}
      - UNI_STATUS_SMTP_PORT=${SMTP_PORT:-1025}
      # Legacy
      - DATABASE_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - SMTP_HOST=${SMTP_HOST:-mailhog}
      - SMTP_PORT=${SMTP_PORT:-1025}
    depends_on:
      db-migrate:
        condition: service_healthy
      redis:
        condition: service_started
      httpbin:
        condition: service_started
      tcp-echo:
        condition: service_started
      ws-echo:
        condition: service_started
      nginx-ssl:
        condition: service_started
      openldap:
        condition: service_started
      mailhog:
        condition: service_started
      rabbitmq:
        condition: service_started
      mosquitto:
        condition: service_started
      openssh:
        condition: service_started
    volumes:
      - ../apps/workers/src:/app/apps/workers/src
      - ../packages:/app/packages
      - /app/node_modules
      - reports_data_test:/app/reports
    networks:
      - uni-status-test

  bullboard:
    image: deadly0/bull-board
    container_name: uni-status-bullboard-test
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - uni-status-test

  mailhog:
    image: mailhog/mailhog
    container_name: uni-status-mailhog-test
    networks:
      - uni-status-test

  # ============================================
  # Test Target Services for Integration Testing
  # ============================================

  # HTTP testing target - provides various HTTP endpoints for testing
  httpbin:
    image: kennethreitz/httpbin:latest
    container_name: uni-status-httpbin-test
    networks:
      - uni-status-test

  # TCP echo server for TCP monitor testing
  tcp-echo:
    image: cjimti/go-echo:latest
    container_name: uni-status-tcp-echo-test
    environment:
      - TCP_PORT=9000
      - NODE_NAME=tcp-echo
    networks:
      - uni-status-test

  # WebSocket echo server for WebSocket monitor testing
  ws-echo:
    image: jmalloc/echo-server:latest
    container_name: uni-status-ws-echo-test
    environment:
      - PORT=8080
    networks:
      - uni-status-test

  # Nginx with SSL for HTTPS/SSL certificate testing
  nginx-ssl:
    image: nginx:alpine
    container_name: uni-status-nginx-ssl-test
    volumes:
      - ./fixtures/nginx:/etc/nginx/fixtures:ro
    command: >
      sh -c "cp /etc/nginx/fixtures/nginx.conf /etc/nginx/nginx.conf &&
             mkdir -p /etc/nginx/certs &&
             cp /etc/nginx/fixtures/certs/* /etc/nginx/certs/ &&
             nginx -g 'daemon off;'"
    networks:
      - uni-status-test

  # RabbitMQ for AMQP monitor testing
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: uni-status-rabbitmq-test
    environment:
      - RABBITMQ_DEFAULT_USER=test
      - RABBITMQ_DEFAULT_PASS=test
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - uni-status-test

  # Eclipse Mosquitto for MQTT monitor testing
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: uni-status-mosquitto-test
    volumes:
      - ./fixtures/mosquitto:/mosquitto/config:ro
    networks:
      - uni-status-test

  # OpenSSH server for SSH monitor testing
  openssh:
    image: linuxserver/openssh-server:latest
    container_name: uni-status-openssh-test
    environment:
      - PUID=1000
      - PGID=1000
      - PASSWORD_ACCESS=true
      - USER_PASSWORD=testpass
      - USER_NAME=testuser
    networks:
      - uni-status-test

  # OpenLDAP for LDAP monitor testing
  openldap:
    image: osixia/openldap:1.5.0
    container_name: uni-status-openldap-test
    environment:
      - LDAP_ORGANISATION=TestOrg
      - LDAP_DOMAIN=test.local
      - LDAP_ADMIN_PASSWORD=admin
    networks:
      - uni-status-test

  haproxy:
    image: haproxy:2.9-alpine
    container_name: uni-status-haproxy-test
    volumes:
      - ../docker/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - web
      - api
    networks:
      - uni-status-test

  test-runner:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    container_name: uni-status-test-runner
    environment:
      - API_BASE_URL=http://uni-status-api-test:3001
      - WEB_BASE_URL=http://uni-status-web-test:3000
      - HAPROXY_BASE_URL=http://uni-status-haproxy-test
      - DATABASE_URL=postgresql://${POSTGRES_USER:-uni_status}:${POSTGRES_PASSWORD:-uni_status_dev}@postgres:5432/${POSTGRES_DB:-uni_status}?sslmode=disable
      - LOG_DIR=/tests/logs
    depends_on:
      - haproxy
      - api
      - web
      - workers
    volumes:
      - ./logs:/tests/logs
    networks:
      - uni-status-test

volumes:
  postgres_data_test:
  redis_data_test:
  uploads_data_test:
  reports_data_test:

networks:
  uni-status-test:
    driver: bridge
