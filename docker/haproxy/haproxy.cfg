global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 5s
    timeout client 50s
    timeout server 50s

frontend http_front
    bind *:80

    # Route /api/auth/* to web backend (better-auth is in Next.js)
    acl is_auth path_beg /api/auth
    use_backend web_backend if is_auth

    # Route API traffic to API backend
    acl is_api path_beg /api
    use_backend api_backend if is_api

    # Health check endpoint for HAProxy itself (for test runner)
    acl is_root path /
    use_backend web_backend if is_root

    # Default to web frontend (handles all other routes including /_next)
    default_backend web_backend

backend api_backend
    balance roundrobin
    server api api:3001

backend web_backend
    balance roundrobin
    option httpchk GET /health
    server web web:3000 check inter 5s fall 3 rise 2
